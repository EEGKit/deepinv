import pytest
import numpy as np
import torch
import deepinv as dinv
import itertools

from deepinv.physics.generator import (
    GaussianMaskGenerator,
    EquispacedMaskGenerator,
    RandomMaskGenerator,
)

# Generators to test (make sure they appear in find_generator as well)
GENERATORS = [
    "MotionBlurGenerator",
    "DiffractionBlurGenerator",
    "ProductConvolutionBlurGenerator",
    "SigmaGenerator",
]

MIXTURES = list(itertools.combinations(GENERATORS, 2))
SIZES = [(5, 5), (6, 6)]
NUM_CHANNELS = [1, 3]


# MRI Generators
C, T, H, W = 2, 12, 256, 512
MRI_GENERATORS = ["gaussian", "random", "uniform"]
MRI_IMG_SIZES = [(H, W), (C, H, W), (C, T, H, W), (64, 64)]
MRI_ACCELERATIONS = [4, 10, 12]
MRI_CENTER_FRACTIONS = [0, 0.04, 24 / 512]

# Inpainting/Splitting Generators
INPAINTING_IMG_SIZES = [
    (2, 64, 40),
    (2, 1000),
    (2, 3, 64, 40),
]  # (C,H,W), (C,M), (C,T,H,W)
INPAINTING_GENERATORS = ["bernoulli", "gaussian"]


def find_generator(name, size, num_channels, device):
    r"""
    Chooses operator

    :param name: operator name
    :param device: (torch.device) cpu or cuda:0
    :return: (deepinv.physics.Physics) forward operator.
    """
    if name == "MotionBlurGenerator":
        g = dinv.physics.generator.MotionBlurGenerator(
            psf_size=size, num_channels=num_channels, device=device
        )
        keys = ["filter"]
    elif name == "DiffractionBlurGenerator":
        g = dinv.physics.generator.DiffractionBlurGenerator(
            psf_size=size,
            device=device,
            num_channels=num_channels,
        )
        keys = ["filter", "coeff", "pupil"]
    elif name == "ProductConvolutionBlurGenerator":
        g = dinv.physics.generator.ProductConvolutionBlurGenerator(
            psf_generator=dinv.physics.generator.DiffractionBlurGenerator(
                psf_size=size,
                device=device,
                num_channels=num_channels,
            ),
            image_size=512,
            n_eigen_psf=10,
            device=device,
        )
        keys = ["filters", "multipliers", "padding"]
    elif name == "SigmaGenerator":
        g = dinv.physics.generator.SigmaGenerator(device=device)
        keys = ["sigma"]
    else:
        raise Exception("The generator chosen doesn't exist")
    return g, size, keys


@pytest.mark.parametrize("name", GENERATORS)
@pytest.mark.parametrize("size", SIZES)
@pytest.mark.parametrize("num_channels", NUM_CHANNELS)
def test_shape(name, size, num_channels, device):
    r"""
    Tests generators shape.
    """

    generator, size, keys = find_generator(name, size, num_channels, device)
    batch_size = 4

    params = generator.step(batch_size=batch_size)

    assert list(params.keys()) == keys

    if "filter" in params.keys():
        assert params["filter"].shape == (batch_size, num_channels, size[0], size[1])


@pytest.mark.parametrize("name", GENERATORS)
def test_generation_newparams(name, device):
    r"""
    Tests generators shape.
    """
    size = (32, 32)
    generator, size, _ = find_generator(name, size, 1, device)
    batch_size = 1

    if name == "MotionBlurGenerator":
        param_key = ["filter"]
    elif name == "DiffractionBlurGenerator":
        param_key = ["filter"]
    elif name == "ProductConvolutionBlurGenerator":
        param_key = ["filters", "multipliers"]
    elif name == "SigmaGenerator":
        param_key = ["sigma"]

    params0 = generator.step(batch_size=batch_size, seed=0)
    params1 = generator.step(batch_size=batch_size, seed=1)

    for key in param_key:
        assert torch.any(params0[key] != params1[key])


@pytest.mark.parametrize("name", GENERATORS)
def test_generation(name, device):
    r"""
    Tests generators shape.
    """
    size = (5, 5)
    generator, size, _ = find_generator(name, size, 1, device)
    batch_size = 1
    params = generator.step(batch_size=batch_size, seed=0)

    if name == "MotionBlurGenerator":
        w = params["filter"]
        if device.type == "cpu":
            wref = torch.tensor(
                [
                    [
                        [
                            [
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.1509433985,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.3081761003,
                                0.1572327018,
                                0.3836477995,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                            ],
                        ]
                    ]
                ]
            )
        elif device.type == "cuda":
            wref = torch.tensor(
                [
                    [
                        [
                            [
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.0691823885,
                                0.0628930852,
                                0.0000000000,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.0503144637,
                                0.4842767417,
                                0.0943396240,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.0000000000,
                                0.1069182381,
                                0.1320754737,
                                0.0000000000,
                            ],
                            [
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                                0.0000000000,
                            ],
                        ]
                    ]
                ],
            ).to(device)

    elif name == "DiffractionBlurGenerator":
        w = params["filter"]
        if device.type == "cpu":
            wref = torch.tensor(
                [
                    [
                        [
                            [
                                0.0113882571,
                                0.0531018935,
                                0.0675100237,
                                0.0303402841,
                                0.0033624785,
                            ],
                            [
                                0.0285054874,
                                0.1004439145,
                                0.1303785592,
                                0.0716396421,
                                0.0116784973,
                            ],
                            [
                                0.0275844987,
                                0.0919832960,
                                0.1246952936,
                                0.0736453235,
                                0.0134703806,
                            ],
                            [
                                0.0105234124,
                                0.0374408774,
                                0.0568509996,
                                0.0335799791,
                                0.0042723534,
                            ],
                            [
                                0.0024160261,
                                0.0023811366,
                                0.0076419995,
                                0.0046625556,
                                0.0005027915,
                            ],
                        ]
                    ]
                ]
            )
        elif device.type == "cuda":
            wref = torch.tensor(
                [
                    [
                        [
                            [
                                0.0095238974,
                                0.0175499711,
                                0.0286177993,
                                0.0064900601,
                                0.0026435892,
                            ],
                            [
                                0.0238581896,
                                0.0537733063,
                                0.0513569079,
                                0.0185344294,
                                0.0124229826,
                            ],
                            [
                                0.0368810110,
                                0.0751009807,
                                0.0805081055,
                                0.0695058778,
                                0.0502106547,
                            ],
                            [
                                0.0210823547,
                                0.0472785048,
                                0.0740763769,
                                0.0966628939,
                                0.0694876462,
                            ],
                            [
                                0.0038343454,
                                0.0082935337,
                                0.0336939581,
                                0.0635016710,
                                0.0451108776,
                            ],
                        ]
                    ]
                ]
            ).to(device)

    elif name == "ProductConvolutionBlurGenerator":
        w = params["filters"]
        if device.type == "cpu":
            wref = torch.tensor(
                [
                    [
                        [
                            [
                                [
                                    -0.0430528857,
                                    0.0381249897,
                                    0.0208994821,
                                    -0.0441075824,
                                    0.2085824013,
                                ],
                                [
                                    -0.0116925370,
                                    0.0413339846,
                                    0.0909898058,
                                    0.0970226899,
                                    0.0133263813,
                                ],
                                [
                                    -0.0760314614,
                                    0.2004818618,
                                    0.0260898303,
                                    -0.4034990370,
                                    0.1039298102,
                                ],
                                [
                                    0.0596825667,
                                    -0.2002762705,
                                    -0.0153927673,
                                    -0.2224996388,
                                    0.0314080231,
                                ],
                                [
                                    -0.1206533834,
                                    0.3131458163,
                                    -0.0471440181,
                                    -0.4513924718,
                                    -0.2459750175,
                                ],
                            ],
                            [
                                [
                                    -0.0666614026,
                                    0.1268066317,
                                    -0.2344553173,
                                    -0.2577445209,
                                    -0.0977975577,
                                ],
                                [
                                    -0.0797299966,
                                    0.1893279701,
                                    -0.1238978207,
                                    -0.0718841553,
                                    -0.1845245361,
                                ],
                                [
                                    -0.3557723463,
                                    0.4580542147,
                                    0.1785860509,
                                    -0.1587517262,
                                    -0.0265364479,
                                ],
                                [
                                    -0.0346775874,
                                    0.0624480397,
                                    -0.0844109580,
                                    0.0444417074,
                                    -0.0031789457,
                                ],
                                [
                                    -0.1778878570,
                                    0.1456786692,
                                    0.0581391566,
                                    -0.2163487822,
                                    0.1203837469,
                                ],
                            ],
                            [
                                [
                                    -0.0677295849,
                                    0.0708412826,
                                    0.0923663378,
                                    -0.0646412000,
                                    0.3797639906,
                                ],
                                [
                                    0.0258787200,
                                    -0.0099311685,
                                    0.3291251361,
                                    0.0374315754,
                                    -0.2142449766,
                                ],
                                [
                                    -0.2368827164,
                                    0.2638994455,
                                    0.1261237115,
                                    -0.2786267996,
                                    0.3186762333,
                                ],
                                [
                                    0.1742828935,
                                    -0.2055627108,
                                    0.2524094880,
                                    -0.0154788913,
                                    0.1503475457,
                                ],
                                [
                                    -0.3739466369,
                                    0.3865113854,
                                    -0.1369484067,
                                    -0.1050377116,
                                    -0.1494401097,
                                ],
                            ],
                            [
                                [
                                    0.1419340223,
                                    -0.1010739654,
                                    -0.1961620003,
                                    0.3021613955,
                                    -0.1612862051,
                                ],
                                [
                                    -0.2423202097,
                                    0.1916725039,
                                    -0.3591038883,
                                    0.1945455819,
                                    -0.0657317936,
                                ],
                                [
                                    -0.3687866330,
                                    0.0331774689,
                                    0.2134723067,
                                    0.2110431045,
                                    -0.0355370156,
                                ],
                                [
                                    -0.0672610402,
                                    0.0555978157,
                                    -0.2103951275,
                                    0.0625923350,
                                    0.0812787563,
                                ],
                                [
                                    -0.3505017161,
                                    -0.2172403634,
                                    0.0609017499,
                                    -0.1059927195,
                                    0.4392176569,
                                ],
                            ],
                            [
                                [
                                    -0.0997615680,
                                    0.0338540152,
                                    0.2082292736,
                                    0.0779390037,
                                    0.3432749510,
                                ],
                                [
                                    -0.0805500895,
                                    0.3617506623,
                                    0.0550577752,
                                    -0.0698817521,
                                    -0.2875291109,
                                ],
                                [
                                    -0.3383533955,
                                    0.0660728067,
                                    0.3731752038,
                                    0.1578095108,
                                    0.2162761688,
                                ],
                                [
                                    0.0080974568,
                                    0.2485173196,
                                    -0.0160681028,
                                    -0.0234121904,
                                    0.3708358109,
                                ],
                                [
                                    -0.5048741698,
                                    -0.0179544669,
                                    0.0486122817,
                                    0.2842772901,
                                    -0.2106457204,
                                ],
                            ],
                            [
                                [
                                    0.3300422728,
                                    0.0311575085,
                                    -0.0874886289,
                                    0.0970353559,
                                    0.0476107858,
                                ],
                                [
                                    -0.3291823268,
                                    -0.1722349972,
                                    -0.3912705779,
                                    0.2455719858,
                                    0.1351490021,
                                ],
                                [
                                    0.1142201126,
                                    -0.0932482779,
                                    0.1173507720,
                                    -0.1899017245,
                                    -0.2644810379,
                                ],
                                [
                                    -0.0968146473,
                                    -0.1261498183,
                                    -0.3091956675,
                                    -0.0139433751,
                                    0.3811086714,
                                ],
                                [
                                    -0.1554311514,
                                    -0.1884487718,
                                    -0.2665721178,
                                    -0.1255756766,
                                    0.1471390128,
                                ],
                            ],
                            [
                                [
                                    -0.0645184442,
                                    0.0001809919,
                                    0.1647349149,
                                    0.0747176558,
                                    0.1476564258,
                                ],
                                [
                                    -0.2084427774,
                                    0.1249909848,
                                    -0.2895229459,
                                    -0.0798877031,
                                    -0.3626595140,
                                ],
                                [
                                    -0.2034374028,
                                    -0.0978602841,
                                    0.3713433743,
                                    0.0752095431,
                                    -0.0161559582,
                                ],
                                [
                                    -0.3801776767,
                                    -0.1609034389,
                                    -0.3226156533,
                                    -0.0877561495,
                                    0.0367760845,
                                ],
                                [
                                    -0.3083783090,
                                    -0.3456141949,
                                    0.2296225429,
                                    -0.0953648910,
                                    -0.3305157423,
                                ],
                            ],
                            [
                                [
                                    -0.0780864507,
                                    -0.1452835053,
                                    0.1585685909,
                                    -0.1958200783,
                                    0.1111887917,
                                ],
                                [
                                    -0.2072092593,
                                    -0.4263575673,
                                    -0.1557587981,
                                    -0.2560985386,
                                    -0.0406716801,
                                ],
                                [
                                    0.1431742311,
                                    0.1089372635,
                                    0.0817657635,
                                    -0.2986866534,
                                    -0.1570590734,
                                ],
                                [
                                    -0.0722294748,
                                    -0.2449529171,
                                    -0.2259958088,
                                    -0.2226318866,
                                    0.2494347394,
                                ],
                                [
                                    0.0142559987,
                                    0.1516341418,
                                    -0.4125473797,
                                    0.0963938013,
                                    0.0461906344,
                                ],
                            ],
                            [
                                [
                                    -0.0351547226,
                                    -0.0054835463,
                                    0.0321789980,
                                    0.0177290812,
                                    -0.0238187350,
                                ],
                                [
                                    -0.0825486407,
                                    -0.0352047198,
                                    -0.0944093838,
                                    0.1330772489,
                                    -0.1438771188,
                                ],
                                [
                                    -0.0570441708,
                                    -0.0663573742,
                                    0.1145556420,
                                    -0.0729085431,
                                    -0.0013971735,
                                ],
                                [
                                    -0.2849518359,
                                    -0.3344321251,
                                    -0.0645076483,
                                    0.2739637792,
                                    -0.3007444739,
                                ],
                                [
                                    -0.0888318717,
                                    -0.2168856561,
                                    0.1008623019,
                                    -0.2462367266,
                                    -0.0387333967,
                                ],
                            ],
                            [
                                [
                                    -0.2563975453,
                                    -0.1542075872,
                                    0.3052588403,
                                    0.2467704415,
                                    -0.1107740030,
                                ],
                                [
                                    -0.0753041059,
                                    -0.2554838061,
                                    -0.0283348486,
                                    -0.2914794981,
                                    -0.0198121052,
                                ],
                                [
                                    -0.0448054671,
                                    0.2739033997,
                                    0.1594663411,
                                    0.3008421659,
                                    0.0902214125,
                                ],
                                [
                                    -0.0505040064,
                                    -0.1330427080,
                                    -0.0765631571,
                                    -0.1753155887,
                                    0.0442979597,
                                ],
                                [
                                    0.0191218909,
                                    0.2510553896,
                                    -0.1550997943,
                                    0.4383403063,
                                    0.2602407038,
                                ],
                            ],
                        ]
                    ]
                ]
            )
        elif device.type == "cuda":
            wref = torch.tensor(
                [
                    [
                        [
                            [
                                [
                                    0.0402549617,
                                    0.0041977353,
                                    -0.0011661241,
                                    -0.1598772556,
                                    0.1862188578,
                                ],
                                [
                                    -0.0656823739,
                                    -0.0446536094,
                                    0.1641064286,
                                    -0.0739662796,
                                    0.0047010044,
                                ],
                                [
                                    0.0790142417,
                                    -0.0564094260,
                                    -0.0697462484,
                                    -0.0633839741,
                                    0.2932346165,
                                ],
                                [
                                    -0.0499558300,
                                    -0.3763730824,
                                    0.1015954986,
                                    -0.0803058147,
                                    -0.0530648641,
                                ],
                                [
                                    0.1073177457,
                                    -0.1152424589,
                                    -0.1447658837,
                                    0.1856819689,
                                    0.3507021964,
                                ],
                            ],
                            [
                                [
                                    0.1546251476,
                                    -0.4323803782,
                                    -0.1646891385,
                                    0.0511225462,
                                    -0.0290640239,
                                ],
                                [
                                    0.0782124996,
                                    -0.0761263892,
                                    -0.1596060693,
                                    0.1775157601,
                                    0.1775856167,
                                ],
                                [
                                    0.4027929902,
                                    -0.1888380051,
                                    -0.1960863620,
                                    -0.1589013934,
                                    0.2167805433,
                                ],
                                [
                                    0.0494116247,
                                    -0.0413754173,
                                    -0.0720849857,
                                    -0.0325963050,
                                    -0.0543866307,
                                ],
                                [
                                    0.2490901947,
                                    0.0575225689,
                                    0.0120933084,
                                    -0.0564055219,
                                    0.0561722666,
                                ],
                            ],
                            [
                                [
                                    0.0889324248,
                                    -0.0135940304,
                                    0.0654176772,
                                    -0.2274201214,
                                    0.2342396379,
                                ],
                                [
                                    -0.0900201350,
                                    0.0430784039,
                                    0.1498138607,
                                    -0.5215086937,
                                    0.0344385318,
                                ],
                                [
                                    0.2333088070,
                                    -0.2611637712,
                                    0.0728961974,
                                    -0.0929111987,
                                    0.3702503741,
                                ],
                                [
                                    -0.2690360546,
                                    0.0579199903,
                                    0.1576261222,
                                    -0.1490220726,
                                    0.0618307553,
                                ],
                                [
                                    0.3126737177,
                                    -0.3874762058,
                                    -0.2053850293,
                                    0.2450116575,
                                    0.1685341299,
                                ],
                            ],
                            [
                                [
                                    -0.1444381028,
                                    0.1072031558,
                                    0.0689127147,
                                    0.2228871584,
                                    -0.1192749664,
                                ],
                                [
                                    0.2207584381,
                                    -0.1970747858,
                                    -0.3747650981,
                                    0.1361738741,
                                    -0.1096572056,
                                ],
                                [
                                    0.3431603312,
                                    0.1878436804,
                                    0.0259330571,
                                    -0.0132006090,
                                    0.0573364198,
                                ],
                                [
                                    0.0854470655,
                                    -0.0458744839,
                                    -0.1283316314,
                                    -0.1433491856,
                                    -0.0781055242,
                                ],
                                [
                                    0.3616443276,
                                    0.2708550692,
                                    0.1239930615,
                                    -0.0994168445,
                                    0.3314072192,
                                ],
                            ],
                            [
                                [
                                    0.1291666180,
                                    -0.0604892857,
                                    0.2400142401,
                                    -0.3076137602,
                                    0.0135158105,
                                ],
                                [
                                    0.2853634357,
                                    0.0103516281,
                                    -0.2281660736,
                                    -0.3250878453,
                                    -0.3515225351,
                                ],
                                [
                                    0.3444132209,
                                    -0.2693577111,
                                    0.4315736592,
                                    -0.1537196636,
                                    -0.0287028942,
                                ],
                                [
                                    -0.0079388134,
                                    0.1791398376,
                                    -0.1728941798,
                                    0.0764324367,
                                    0.1377844959,
                                ],
                                [
                                    0.4581085742,
                                    -0.1324399263,
                                    -0.0165031292,
                                    0.1005635783,
                                    -0.3161503077,
                                ],
                            ],
                            [
                                [
                                    -0.2870815694,
                                    0.0734322816,
                                    -0.0900458321,
                                    0.0090224715,
                                    -0.0633379444,
                                ],
                                [
                                    0.3328187466,
                                    0.1934642345,
                                    -0.4371370375,
                                    -0.2506422400,
                                    -0.2869578302,
                                ],
                                [
                                    -0.0951871946,
                                    -0.1278708726,
                                    0.0619850233,
                                    -0.0609727576,
                                    -0.2281261384,
                                ],
                                [
                                    0.1276779175,
                                    0.1509474218,
                                    -0.1670159101,
                                    -0.4936627150,
                                    0.0886950493,
                                ],
                                [
                                    0.0614670925,
                                    0.0253298581,
                                    0.2266703993,
                                    0.1871052682,
                                    0.3307791352,
                                ],
                            ],
                            [
                                [
                                    0.0847302899,
                                    -0.0414181575,
                                    0.1610004604,
                                    -0.1560816169,
                                    -0.0655477345,
                                ],
                                [
                                    0.3473277688,
                                    -0.1097557470,
                                    0.0649005771,
                                    0.1578507423,
                                    -0.4252947867,
                                ],
                                [
                                    0.2390655279,
                                    0.0351499170,
                                    0.4173869491,
                                    0.0407920107,
                                    -0.1150225401,
                                ],
                                [
                                    0.2188140005,
                                    -0.2855404615,
                                    0.1861250997,
                                    0.3040124774,
                                    0.1721864790,
                                ],
                                [
                                    0.3350175917,
                                    0.3447727859,
                                    0.1914794147,
                                    0.2576644123,
                                    -0.1616712809,
                                ],
                            ],
                            [
                                [
                                    -0.0474528521,
                                    -0.2270647585,
                                    -0.0816431493,
                                    -0.2410204113,
                                    0.2794277966,
                                ],
                                [
                                    0.2471812516,
                                    0.4572430849,
                                    -0.1228315085,
                                    -0.0179424398,
                                    0.0944985971,
                                ],
                                [
                                    -0.0700480714,
                                    -0.0552149788,
                                    -0.2531837523,
                                    -0.0402936600,
                                    -0.1200570166,
                                ],
                                [
                                    0.0982317626,
                                    0.2029752135,
                                    -0.0495142415,
                                    -0.2558777928,
                                    0.2656354904,
                                ],
                                [
                                    -0.0581252128,
                                    0.0431816280,
                                    -0.1834789366,
                                    0.4608024657,
                                    0.0685200468,
                                ],
                            ],
                            [
                                [
                                    0.0443227962,
                                    -0.0104394322,
                                    0.0093001490,
                                    0.0029580265,
                                    -0.0028149267,
                                ],
                                [
                                    0.1061630100,
                                    0.0191910025,
                                    0.1890083849,
                                    0.0213262625,
                                    -0.3803712130,
                                ],
                                [
                                    0.0831394717,
                                    0.1412344128,
                                    0.0678368285,
                                    0.1369182765,
                                    0.0551367104,
                                ],
                                [
                                    0.0887894481,
                                    -0.0604423210,
                                    0.5822353363,
                                    0.1086879373,
                                    -0.1470113695,
                                ],
                                [
                                    0.1204210445,
                                    0.2982436717,
                                    0.0872304812,
                                    0.3162720203,
                                    0.1653257161,
                                ],
                            ],
                            [
                                [
                                    0.0611299165,
                                    0.2583647370,
                                    0.3177891076,
                                    -0.1194299981,
                                    -0.0103822211,
                                ],
                                [
                                    0.1000070944,
                                    0.2611202300,
                                    0.0581384152,
                                    0.1781256646,
                                    0.2983043790,
                                ],
                                [
                                    0.1206250414,
                                    0.4622469544,
                                    -0.1560529321,
                                    0.0330482312,
                                    -0.1773042083,
                                ],
                                [
                                    0.0546467900,
                                    0.1153122187,
                                    0.0410263315,
                                    -0.0167040601,
                                    0.2228831053,
                                ],
                                [
                                    0.0431176759,
                                    0.1264810562,
                                    -0.2007720172,
                                    0.1891323328,
                                    -0.0156119810,
                                ],
                            ],
                        ]
                    ]
                ]
            ).to(device)

    elif name == "SigmaGenerator":
        w = params["sigma"]
        if device.type == "cpu":
            wref = torch.tensor([0.2531657219])
        elif device.type == "cuda":
            wref = torch.tensor([0.2055327892]).to(device)

    assert torch.allclose(w, wref, atol=1e-6)


######################
### MRI GENERATORS ###
######################


@pytest.fixture
def batch_size():
    return 2


def choose_mri_generator(generator_name, img_size, acc, center_fraction):
    if generator_name == "gaussian":
        g = GaussianMaskGenerator(
            img_size, acceleration=acc, center_fraction=center_fraction
        )
    elif generator_name == "random":
        g = RandomMaskGenerator(
            img_size, acceleration=acc, center_fraction=center_fraction
        )
    elif generator_name == "uniform":
        g = EquispacedMaskGenerator(
            img_size, acceleration=acc, center_fraction=center_fraction
        )
    return g


@pytest.mark.parametrize("generator_name", MRI_GENERATORS)
@pytest.mark.parametrize("img_size", MRI_IMG_SIZES)
@pytest.mark.parametrize("acc", MRI_ACCELERATIONS)
@pytest.mark.parametrize("center_fraction", MRI_CENTER_FRACTIONS)
def test_mri_generator(generator_name, img_size, batch_size, acc, center_fraction):
    generator = choose_mri_generator(generator_name, img_size, acc, center_fraction)
    # test across different accs and centre fracations
    H, W = img_size[-2:]
    assert W // generator.acc == (generator.n_lines + generator.n_center)

    mask = generator.step(batch_size=batch_size, seed=0)["mask"]

    if len(img_size) == 2:
        assert len(mask.shape) == 4
        C = 1
    elif len(img_size) == 3:
        assert len(mask.shape) == 4
        C = img_size[0]
    elif len(img_size) == 4:
        assert len(mask.shape) == 5
        C = img_size[0]
        assert mask.shape[2] == img_size[1]

    assert mask.shape[0] == batch_size
    assert mask.shape[1] == C
    assert mask.shape[-2:] == img_size[-2:]

    for b in range(batch_size):
        for c in range(C):
            if len(img_size) == 4:
                for t in range(img_size[1]):
                    mask[b, c, t, :, :].sum() * generator.acc == H * W
            else:
                mask[b, c, :, :].sum() * generator.acc == H * W

    mask2 = generator.step(batch_size=batch_size)["mask"]

    if generator.n_lines != 0 and generator_name != "uniform":
        assert not torch.allclose(mask, mask2)


#############################
### INPAINTING GENERATORS ###
#############################


def choose_inpainting_generator(name, img_size, split_ratio, pixelwise, device):
    if name == "bernoulli":
        return dinv.physics.generator.BernoulliSplittingMaskGenerator(
            tensor_size=img_size,
            split_ratio=split_ratio,
            device=device,
            pixelwise=pixelwise,
            rng=torch.Generator(device).manual_seed(0),
        )
    elif name == "gaussian":
        return dinv.physics.generator.GaussianSplittingMaskGenerator(
            tensor_size=img_size,
            split_ratio=split_ratio,
            device=device,
            pixelwise=pixelwise,
            rng=torch.Generator(device).manual_seed(0),
        )
    else:
        raise Exception("The generator chosen doesn't exist")


@pytest.mark.parametrize("generator_name", INPAINTING_GENERATORS)
@pytest.mark.parametrize("img_size", INPAINTING_IMG_SIZES)
@pytest.mark.parametrize("pixelwise", (False, True))
@pytest.mark.parametrize("split_ratio", (0.5,))
def test_inpainting_generators(
    generator_name, batch_size, img_size, pixelwise, split_ratio, device
):
    if generator_name == "gaussian" and len(img_size) < 3:
        pytest.skip(
            "Gaussian splitting mask not valid for images of shape smaller than (C, H, W)"
        )

    gen = choose_inpainting_generator(
        generator_name, img_size, split_ratio, pixelwise, device
    )  # Assume generator always receives "correct" img_size i.e. not one with dims missing

    def correct_ratio(ratio):
        assert torch.isclose(
            ratio,
            torch.tensor([split_ratio], device=device),
            rtol=1e-2,
            atol=1e-2,
        )

    def correct_pixelwise(mask):
        if pixelwise:
            assert torch.all(mask[:, 0, ...] == mask[:, 1, ...])
        else:
            assert not torch.all(mask[:, 0, ...] == mask[:, 1, ...])

    # Standard generate mask
    mask1 = gen.step(batch_size=batch_size, seed=0)["mask"]
    correct_ratio(mask1.sum() / np.prod((batch_size, *img_size)))
    correct_pixelwise(mask1)

    # Standard without batch dim
    mask1 = gen.step(batch_size=None, seed=0)["mask"]
    assert tuple(mask1.shape) == tuple(img_size)
    correct_ratio(mask1.sum() / np.prod(img_size))

    # Standard mask but by passing flat input_mask of ones
    input_mask = torch.ones(batch_size, *img_size)
    # should ignore batch_size
    mask2 = gen.step(batch_size=batch_size, input_mask=input_mask, seed=0)["mask"]
    correct_ratio(mask2.sum() / input_mask.sum())
    correct_pixelwise(mask2)

    # As above but with no batch dimension in input_mask
    input_mask = torch.ones(*img_size, device=device)
    mask2 = gen.step(batch_size=batch_size, input_mask=input_mask, seed=0)[
        "mask"
    ]  # should use batch_size
    correct_ratio(mask2.sum() / input_mask.sum() / batch_size)

    # As above but with img_size missing channel dimension (bad practice)
    input_mask = torch.ones(*img_size[1:], device=device)
    mask2 = gen.step(batch_size=batch_size, input_mask=input_mask, seed=0)["mask"]
    correct_ratio(mask2.sum() / input_mask.sum() / batch_size)

    # Generate splitting mask from already subsampled mask
    input_mask = torch.zeros(batch_size, *img_size, device=device)
    input_mask[..., 10:20] = 1
    mask3 = gen.step(batch_size=batch_size, input_mask=input_mask, seed=0)["mask"]
    correct_ratio(mask3.sum() / input_mask.sum())
    correct_pixelwise(mask3)
